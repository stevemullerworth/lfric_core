!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------
!> @brief Test the functionality of cosmic_flux_mod

module cosmic_flux_mod_test
  implicit none

contains

  @test
  subroutine frac_and_int_part_test()
    use pFUnit_Mod
    use constants_mod, only: r_def
    use cosmic_flux_mod, only : frac_and_int_part

    real(kind=r_def) :: x_value, frac_x, tol
    integer          :: int_x

    tol = 1.0e-6_r_def
    x_value = -3.4_r_def
    call frac_and_int_part(x_value,int_x,frac_x)
    @assertEqual(4, int_x)
    @assertEqual(0.4_r_def, frac_x, tol)

    x_value = 3.4_r_def
    call frac_and_int_part(x_value,int_x,frac_x)
    @assertEqual(4, int_x)
    @assertEqual(0.4_r_def, frac_x, tol)

  end subroutine frac_and_int_part_test


  @test
  subroutine populate_array_test()
    use pFUnit_Mod
    use constants_mod, only: r_def
    use cosmic_flux_mod, only : populate_array

    real(kind=r_def) :: departure_dist
    integer          :: edge_option, nCells
    integer, allocatable :: index_array(:)

    nCells = 4

    allocate(index_array(1:nCells))

    departure_dist = 3.4_r_def
    edge_option = 0
    call populate_array(ncells,index_array,departure_dist, edge_option)
    @assertEqual(-1, index_array(1))
    @assertEqual(-2, index_array(2))
    @assertEqual(-3, index_array(3))
    @assertEqual(-4, index_array(4))

    edge_option = 1
    call populate_array(ncells,index_array,departure_dist, edge_option)
    @assertEqual(0, index_array(1))
    @assertEqual(-1, index_array(2))
    @assertEqual(-2, index_array(3))
    @assertEqual(-3, index_array(4))

    departure_dist = -3.4
    edge_option = 0
    call populate_array(ncells,index_array,departure_dist, edge_option)
    @assertEqual(0, index_array(1))
    @assertEqual(1, index_array(2))
    @assertEqual(2, index_array(3))
    @assertEqual(3, index_array(4))

    edge_option = 1
    call populate_array(ncells,index_array,departure_dist, edge_option)
    @assertEqual(1, index_array(1))
    @assertEqual(2, index_array(2))
    @assertEqual(3, index_array(3))
    @assertEqual(4, index_array(4))

    deallocate(index_array)

  end subroutine populate_array_test


  @test
  subroutine calc_integration_limits_test()
    use pFUnit_Mod
    use constants_mod, only: r_def
    use cosmic_flux_mod, only : calc_integration_limits

    real(kind=r_def) :: departure_dist
    real(kind=r_def) :: frac_x
    real(kind=r_def) :: x_left_limit
    real(kind=r_def) :: x_right_limit
    real(kind=r_def) :: tol

    departure_dist = 3.4_r_def
    frac_x = 0.4_r_def
    tol = 1.0e-6_r_def
    call calc_integration_limits(departure_dist,frac_x,x_left_limit,x_right_limit)
    @assertEqual(0.6_r_def, x_left_limit,tol)
    @assertEqual(1.0_r_def, x_right_limit,tol)

    departure_dist = -3.4_r_def
    frac_x = 0.4_r_def
    call calc_integration_limits(departure_dist,frac_x,x_left_limit,x_right_limit)
    @assertEqual(0.0_r_def, x_left_limit,tol)
    @assertEqual(0.4_r_def, x_right_limit,tol)

  end subroutine calc_integration_limits_test


  @test
  subroutine map_cell_index_test()
    use pFUnit_Mod
    use cosmic_flux_mod, only : map_cell_index

    integer :: cell_index, ii, stencil_length

    stencil_length = 9

    ii = -4
    cell_index = map_cell_index(ii,stencil_length)
    @assertEqual(1, cell_index)

    ii = -3
    cell_index = map_cell_index(ii,stencil_length)
    @assertEqual(2, cell_index)

    ii = -2
    cell_index = map_cell_index(ii,stencil_length)
    @assertEqual(3, cell_index)

    ii = 1
    cell_index = map_cell_index(ii,stencil_length)
    @assertEqual(6, cell_index)

    ii = 4
    cell_index = map_cell_index(ii,stencil_length)
    @assertEqual(9, cell_index)

  end subroutine map_cell_index_test


  @test
  subroutine return_part_mass_test()
    use pFUnit_Mod
    use constants_mod, only: r_def
    use cosmic_flux_mod, only : return_part_mass

    real(kind=r_def) :: x_left_limit, x_right_limit, part_mass, tol
    real(kind=r_def), allocatable :: subgrid_coeffs(:)
    integer :: n_coeffs

    tol = 1.0e-6_r_def
    n_coeffs = 3
    allocate(subgrid_coeffs(1:n_coeffs))
    subgrid_coeffs = (/ 1.0_r_def,1.0_r_def,1.0_r_def /)

    x_left_limit  = 0.0_r_def
    x_right_limit = 0.5_r_def

    part_mass = return_part_mass(n_coeffs,subgrid_coeffs,x_left_limit,x_right_limit)
    @assertEqual((2.0_r_def/3.0_r_def), part_mass,tol)

    deallocate(subgrid_coeffs)

  end subroutine return_part_mass_test


  @test
  subroutine eval_integral_test()
    use pFUnit_Mod
    use constants_mod, only: r_def
    use cosmic_flux_mod, only : eval_integral

    real(kind=r_def) :: func_at_x, xx, tol
    real(kind=r_def), allocatable :: subgrid_coeffs(:)
    integer :: n_coeffs

    n_coeffs = 3
    allocate(subgrid_coeffs(1:n_coeffs))
    subgrid_coeffs = (/ 1.0_r_def,1.0_r_def,1.0_r_def /)

    xx = 0.5_r_def
    tol = 1.0e-6_r_def

    func_at_x = eval_integral(n_coeffs,subgrid_coeffs,xx)
    @assertEqual((2.0_r_def/3.0_r_def), func_at_x,tol)

    deallocate(subgrid_coeffs)

  end subroutine eval_integral_test


  @test
  subroutine calc_stencil_ordering_test()
    use pFUnit_Mod
    use cosmic_flux_mod, only : calc_stencil_ordering

    integer :: stencil_length
    integer, allocatable :: stencil_order_out(:)

    stencil_length = 9
    allocate(stencil_order_out(1:stencil_length))

    call calc_stencil_ordering(stencil_length,stencil_order_out)

    @assertEqual(8, stencil_order_out(1))
    @assertEqual(6, stencil_order_out(2))
    @assertEqual(4, stencil_order_out(3))
    @assertEqual(2, stencil_order_out(4))
    @assertEqual(1, stencil_order_out(5))
    @assertEqual(3, stencil_order_out(6))
    @assertEqual(5, stencil_order_out(7))
    @assertEqual(7, stencil_order_out(8))
    @assertEqual(9, stencil_order_out(9))

    deallocate(stencil_order_out)

  end subroutine calc_stencil_ordering_test


  @test
  subroutine stencil_ordering_and_orientation_test()
    use pFUnit_Mod
    use cosmic_flux_mod, only : stencil_ordering_and_orientation
    use flux_direction_mod, only : x_direction, y_direction

    integer :: stencil_length
    integer :: orientation
    integer, allocatable :: stencil_order_out(:)

    stencil_length = 9
    allocate(stencil_order_out(1:stencil_length))
    orientation = 1

    call stencil_ordering_and_orientation(stencil_length,orientation,x_direction,stencil_order_out)

    @assertEqual(8, stencil_order_out(1))
    @assertEqual(6, stencil_order_out(2))
    @assertEqual(4, stencil_order_out(3))
    @assertEqual(2, stencil_order_out(4))
    @assertEqual(1, stencil_order_out(5))
    @assertEqual(3, stencil_order_out(6))
    @assertEqual(5, stencil_order_out(7))
    @assertEqual(7, stencil_order_out(8))
    @assertEqual(9, stencil_order_out(9))


    orientation = 4

    call stencil_ordering_and_orientation(stencil_length,orientation,x_direction,stencil_order_out)

    @assertEqual(9, stencil_order_out(1))
    @assertEqual(7, stencil_order_out(2))
    @assertEqual(5, stencil_order_out(3))
    @assertEqual(3, stencil_order_out(4))
    @assertEqual(1, stencil_order_out(5))
    @assertEqual(2, stencil_order_out(6))
    @assertEqual(4, stencil_order_out(7))
    @assertEqual(6, stencil_order_out(8))
    @assertEqual(8, stencil_order_out(9))

    orientation = 1

    call stencil_ordering_and_orientation(stencil_length,orientation,y_direction,stencil_order_out)

    @assertEqual(8, stencil_order_out(1))
    @assertEqual(6, stencil_order_out(2))
    @assertEqual(4, stencil_order_out(3))
    @assertEqual(2, stencil_order_out(4))
    @assertEqual(1, stencil_order_out(5))
    @assertEqual(3, stencil_order_out(6))
    @assertEqual(5, stencil_order_out(7))
    @assertEqual(7, stencil_order_out(8))
    @assertEqual(9, stencil_order_out(9))

    orientation = 2

    call stencil_ordering_and_orientation(stencil_length,orientation,y_direction,stencil_order_out)

    @assertEqual(9, stencil_order_out(1))
    @assertEqual(7, stencil_order_out(2))
    @assertEqual(5, stencil_order_out(3))
    @assertEqual(3, stencil_order_out(4))
    @assertEqual(1, stencil_order_out(5))
    @assertEqual(2, stencil_order_out(6))
    @assertEqual(4, stencil_order_out(7))
    @assertEqual(6, stencil_order_out(8))
    @assertEqual(8, stencil_order_out(9))

    deallocate(stencil_order_out)

  end subroutine stencil_ordering_and_orientation_test

end module cosmic_flux_mod_test
