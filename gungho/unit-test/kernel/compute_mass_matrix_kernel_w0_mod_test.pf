!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------

!> Test the W0 mass matrix computation
!>
module compute_mass_matrix_kernel_w0_mod_test

    use constants_mod, only : i_def, r_def
    use get_unit_test_m3x3_dofmap_mod, &
      only : get_w0_m3x3_dofmap
    use get_unit_test_m3x3_q3x3x3_sizes_mod, &
      only : get_w0_m3x3_q3x3x3_size
    use get_unit_test_q3x3x3_basis_mod, &
      only : get_w0_q3x3x3_basis, get_w0_q3x3x3_diff_basis
    use get_unit_test_q3x3x3_quadrature_mod,            &
      only : get_gaussian_q3x3x3_quadrature_weights_xy, &
             get_gaussian_q3x3x3_quadrature_weights_z
    use get_unit_test_3x3x3_chi_mod, &
      only : get_w0_3x3x3_field
    use mpi_mod,       only : store_comm, clear_comm
    use pFUnit_Mod
    use yaxt,          only : xt_initialize, xt_finalize

  implicit none

  private
  public :: test_all

  @TestCase
  type, extends(MPITestCase), public :: compute_mass_matrix_w0_test_type
    private
  contains
    procedure setUp
    procedure tearDown
    procedure test_all
  end type compute_mass_matrix_w0_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    use finite_element_config_mod, only : cellshape_quadrilateral

    implicit none

    class(compute_mass_matrix_w0_test_type), intent(inout) :: this

    ! Initialise YAXT
    call xt_initialize(this%getMpiCommunicator())
    !Store the MPI communicator for later use
    call store_comm(this%getMpiCommunicator())

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(compute_mass_matrix_w0_test_type), intent(inout) :: this

    ! Finalise YAXT
    call xt_finalize()
    ! Clear the stored MPI communicator
    call clear_comm()

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test( npes=[1] )
  subroutine test_all( this )

    use compute_mass_matrix_kernel_w0_mod, only : compute_mass_matrix_w0_code

    implicit none

    class(compute_mass_matrix_w0_test_type), intent(inout) :: this

    real(r_def), parameter :: tol = 1.0e-6_r_def
    real(r_def), parameter :: dx = 6000.0_r_def
    real(r_def), parameter :: dy = 1000.0_r_def
    real(r_def), parameter :: dz = 2000.0_r_def
    integer(i_def), parameter :: nlayers = 3

    integer :: i, j, k, cell

    ! Required for calling mass matrix kernel
    integer(i_def) :: ndf_w0, undf_w0
    integer(i_def) :: ncells, ncell_3d
    integer(i_def) :: unused
    integer(i_def) :: nqp_h, nqp_v

    integer(i_def), allocatable :: map_w0(:,:)
    real(r_def), allocatable :: chi1(:), chi2(:), chi3(:)
    real(r_def), allocatable :: basis_w0(:,:,:,:), diff_basis_w0(:,:,:,:)
    real(r_def), allocatable :: wh(:), wv(:)
    real(r_def), allocatable :: local_stencil(:,:,:)

    real(r_def), dimension(8,8) :: answer

    call get_w0_m3x3_q3x3x3_size( ndf_w0, undf_w0, ncells, &
                                  unused, unused, &
                                  nqp_h, nqp_v, nlayers=nlayers)
    call get_w0_m3x3_dofmap( map_w0 )
    call get_w0_q3x3x3_basis( basis_w0 )
    call get_w0_q3x3x3_diff_basis( diff_basis_w0 )
    call get_gaussian_q3x3x3_quadrature_weights_xy( wh )
    call get_gaussian_q3x3x3_quadrature_weights_z( wv )

    ! Compute coordinates
    allocate(chi1(undf_w0))
    allocate(chi2(undf_w0))
    allocate(chi3(undf_w0))

    call get_w0_3x3x3_field(chi1, chi2, chi3, dx, dy, dz, &
                            map_w0, nlayers)

    ! Test mass matrix kernel
    cell = 1
    ncell_3d = ncells * nlayers
    ! Create the data
    allocate( local_stencil(ndf_w0, ndf_w0, ncell_3d) )
    local_stencil(:,:,:) = 0.0_r_def
    call compute_mass_matrix_w0_code( cell,            &
                                      nlayers,         &
                                      ncell_3d,        &
                                      local_stencil,   &
                                      chi1,            &
                                      chi2,            &
                                      chi3,            &
                                      ndf_w0,          &
                                      basis_w0,        &
                                      ndf_w0,          &
                                      undf_w0,         &
                                      map_w0(:, cell), &
                                      diff_basis_w0,   &
                                      nqp_h,           &
                                      nqp_v,           &
                                      wh,              &
                                      wv )

    call mass_matrix_w0(answer)
    ! Normalise answers by volume element
    answer = answer(:,:) / (dx*dy*dz)
    local_stencil(:, :, 1 ) = local_stencil(:, :, 1 )/(dx*dy*dz)
    @assertEqual(answer, local_stencil(:, :, 1 ), tol)

    deallocate( local_stencil )
    deallocate( chi3, chi2, chi1 )
    deallocate( wv, wh )
    deallocate( diff_basis_w0,basis_w0 )
    deallocate( map_w0 )

  end subroutine test_all

  subroutine mass_matrix_w0( mm )
    use constants_mod, only: r_def
    implicit none

    real(kind=r_def), dimension(8,8), intent(inout) :: mm
    mm = reshape( [ &
  0.4444444444444401E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.1111111111111104E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.5555555555555524E+08_r_def, &
  0.1111111111111103E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.4444444444444401E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.1111111111111104E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.1111111111111104E+09_r_def, &
  0.5555555555555524E+08_r_def, &
  0.1111111111111104E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.4444444444444401E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.5555555555555524E+08_r_def, &
  0.1111111111111104E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.1111111111111104E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.1111111111111104E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.4444444444444401E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.5555555555555524E+08_r_def, &
  0.1111111111111104E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.5555555555555524E+08_r_def, &
  0.1111111111111103E+09_r_def, &
  0.4444444444444401E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.1111111111111104E+09_r_def, &
  0.5555555555555524E+08_r_def, &
  0.2222222222222203E+09_r_def, &
  0.4444444444444399E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.5555555555555524E+08_r_def, &
  0.1111111111111104E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.1111111111111104E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.4444444444444399E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.5555555555555524E+08_r_def, &
  0.1111111111111104E+09_r_def, &
  0.2222222222222204E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.1111111111111103E+09_r_def, &
  0.2222222222222203E+09_r_def, &
  0.4444444444444400E+09_r_def  &
    ], shape(mm) )
    return
  end subroutine mass_matrix_w0

end module compute_mass_matrix_kernel_w0_mod_test
