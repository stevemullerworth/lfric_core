!-----------------------------------------------------------------------------
! (c) Crown copyright 2023 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> Test the sorting of columns of data to remove static instability
!>
module sort_column_above_kernel_mod_test

  use constants_mod, only: i_def, r_single, r_double, r_def
  use funit

  implicit none

  private
  public :: test_real64, test_real32

  @TestCase
  type, extends(TestCase), public :: sort_column_above_test_type
    private
  contains
    procedure setup
    procedure tearDown
    procedure test_real64
    procedure test_real32
  end type sort_column_above_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    implicit none

    class(sort_column_above_test_type), intent(inout) :: this

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(sort_column_above_test_type), intent(inout) :: this

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_real32( this )

    use sci_sort_column_above_kernel_mod, only : sort_column_above_code

    implicit none

    class(sort_column_above_test_type), intent(inout) :: this

    ! Mesh is a single column with 10 layers (and so 11 Wtheta points)
    integer(i_def), parameter :: nlayers = 10
    integer(i_def), parameter :: ncells = nlayers
    integer(i_def), parameter :: ndf_wtheta = 2
    integer(i_def), parameter :: undf_wtheta = nlayers + 1

    integer(i_def) :: map_wtheta(ndf_wtheta)
    real(r_single) :: theta(undf_wtheta)
    real(r_def)    :: height_wt(undf_wtheta)
    real(r_single) :: answer(undf_wtheta)
    real(r_def)    :: height_to_sort_above

    ! ------------------------------------------------------------------------ !
    ! Set up field and dofmap arrays
    ! ------------------------------------------------------------------------ !

    map_wtheta = (/ 1, 2 /)

    ! Some fairly random increasing height field (not important!)
    height_wt(:) = (/  0.0_r_def,  2.0_r_def,  5.0_r_def,  6.0_r_def, &
                       7.5_r_def, 10.0_r_def, 11.0_r_def, 11.5_r_def, &
                      13.5_r_def, 16.0_r_def, 20.0_r_def /)
    height_to_sort_above = 8.0_r_def  ! Sort values 6-11 in column

    ! Initial theta unsorted (and generally decreasing)
    theta(:) = (/ 300.0_r_single, 299.0_r_single, 289.5_r_single, 299.5_r_single, &
                  287.0_r_single, 286.0_r_single, 250.0_r_single, 271.0_r_single, &
                  268.0_r_single, 264.0_r_single, 242.0_r_single /)
    ! Answer is the same as theta but values 6-11 sorted in increasing order
    answer(:) = (/ 300.0_r_single, 299.0_r_single, 289.5_r_single, 299.5_r_single, &
                   287.0_r_single, 242.0_r_single, 250.0_r_single, 264.0_r_single, &
                   268.0_r_single, 271.0_r_single, 286.0_r_single /)

    ! ------------------------------------------------------------------------ !
    ! Run kernel and check
    ! ------------------------------------------------------------------------ !

    call sort_column_above_code( nlayers,              &
                                 theta,                &
                                 height_wt,            &
                                 height_to_sort_above, &
                                 ndf_wtheta,           &
                                 undf_wtheta,          &
                                 map_wtheta )

    @assertEqual( theta, answer )

  end subroutine test_real32

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_real64( this )

    use sci_sort_column_above_kernel_mod, only : sort_column_above_code

    implicit none

    class(sort_column_above_test_type), intent(inout) :: this

    ! Mesh is a single column with 10 layers (and so 11 Wtheta points)
    integer(i_def), parameter :: nlayers = 10
    integer(i_def), parameter :: ncells = nlayers
    integer(i_def), parameter :: ndf_wtheta = 2
    integer(i_def), parameter :: undf_wtheta = nlayers + 1

    integer(i_def) :: map_wtheta(ndf_wtheta)
    real(r_double) :: theta(undf_wtheta)
    real(r_def)    :: height_wt(undf_wtheta)
    real(r_double) :: answer(undf_wtheta)
    real(r_def)    :: height_to_sort_above

    ! ------------------------------------------------------------------------ !
    ! Set up field and dofmap arrays
    ! ------------------------------------------------------------------------ !

    map_wtheta = (/ 1, 2 /)

    ! Some fairly random increasing height field (not important!)
    height_wt(:) = (/  0.0_r_def,  2.0_r_def,  5.0_r_def,  6.0_r_def, &
                       7.5_r_def, 10.0_r_def, 11.0_r_def, 11.5_r_def, &
                      13.5_r_def, 16.0_r_def, 20.0_r_def /)
    height_to_sort_above = 8.0_r_def  ! Sort values 6-11 in column

    ! Initial theta unsorted (and generally decreasing)
    theta(:) = (/ 300.0_r_double, 299.0_r_double, 289.5_r_double, 299.5_r_double, &
                  287.0_r_double, 286.0_r_double, 250.0_r_double, 271.0_r_double, &
                  268.0_r_double, 264.0_r_double, 242.0_r_double /)
    ! Answer is the same as theta but values 6-11 sorted in increasing order
    answer(:) = (/ 300.0_r_double, 299.0_r_double, 289.5_r_double, 299.5_r_double, &
                   287.0_r_double, 242.0_r_double, 250.0_r_double, 264.0_r_double, &
                   268.0_r_double, 271.0_r_double, 286.0_r_double /)

    ! ------------------------------------------------------------------------ !
    ! Run kernel and check
    ! ------------------------------------------------------------------------ !

    call sort_column_above_code( nlayers,              &
                                 theta,                &
                                 height_wt,            &
                                 height_to_sort_above, &
                                 ndf_wtheta,           &
                                 undf_wtheta,          &
                                 map_wtheta )

    @assertEqual( theta, answer )

  end subroutine test_real64

end module sort_column_above_kernel_mod_test
