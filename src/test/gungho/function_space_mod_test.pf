!-------------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-------------------------------------------------------------------------------
!
!-------------------------------------------------------------------------------
module function_space_mod_test
  implicit none 

contains

  @test
  subroutine test_func_space()
    use pFUnit_Mod
    use function_space_mod, only : function_space_type, V0, V1, V2, V3
    use constants_mod, only : r_def
    use mesh_mod, only : num_cells, v_unique_dofs, num_layers
    use gaussian_quadrature_mod, only : ngp_h, ngp_v
    use basis_function_mod,         only : &
              v0_basis, v1_basis, v2_basis, v3_basis, &
              v0_diff_basis, v1_diff_basis, v2_diff_basis, v3_diff_basis, &
              v0_nodal_coords, v1_nodal_coords, v2_nodal_coords, v3_nodal_coords
    use dofmap_mod,                 only : &
              v0_dofmap, v1_dofmap, v2_dofmap, v3_dofmap
    implicit none

    type(function_space_type) :: v0_func_space, v1_func_space, &
                                 v2_func_space, v3_func_space

    integer          :: num_dofs, num_unique_dofs
    integer          :: testncell, testundf, test_fs
    real(kind=r_def), pointer, dimension(:,:,:,:) :: test_basis
    integer          :: i,j
    integer, pointer :: testmap(:)
    real(kind=r_def) :: epsilon
    real(kind=r_def), pointer, dimension(:,:) :: test_nodes

    integer          :: test_v0_dofmap_result_1,&
                        test_v0_dofmap_result_2

    real(kind=r_def) :: test_v0_basis_result, &
                        test_v0_diff_basis_result

    real(kind=r_def) :: test_v0_nodal_coords_1, &
                        test_v0_nodal_coords_2, &
                        test_v0_nodal_coords_3

    integer          :: test_v1_dofmap_result_1,&
                        test_v1_dofmap_result_2

    real(kind=r_def) :: test_v1_basis_result, &
                        test_v1_diff_basis_result

    real(kind=r_def) :: test_v1_nodal_coords_1, &
                        test_v1_nodal_coords_2, &
                        test_v1_nodal_coords_3

    integer          :: test_v2_dofmap_result_1,&
                        test_v2_dofmap_result_2

    real(kind=r_def) :: test_v2_basis_result, &
                        test_v2_diff_basis_result

    real(kind=r_def) :: test_v2_nodal_coords_1, &
                        test_v2_nodal_coords_2, &
                        test_v2_nodal_coords_3

    integer          :: test_v3_dofmap_result_1,&
                        test_v3_dofmap_result_2

    real(kind=r_def) :: test_v3_basis_result, &
                        test_v3_diff_basis_result

    real(kind=r_def) :: test_v3_nodal_coords_1, &
                        test_v3_nodal_coords_2, &
                        test_v3_nodal_coords_3
    
    ! set some sizes ...
    num_cells = 35
    num_layers = 50
    num_dofs=4
    num_unique_dofs = 100
    do i=1,4
      v_unique_dofs(i,1)=num_unique_dofs
      v_unique_dofs(i,2)=num_dofs
    enddo

    if ( allocated( v0_basis ) ) then
      deallocate( v0_basis )
      deallocate( v0_diff_basis )
      deallocate( v0_nodal_coords )
      deallocate( v0_dofmap )
    end if
    if ( allocated( v1_basis ) ) then
      deallocate( v1_basis )
      deallocate( v1_diff_basis )
      deallocate( v1_nodal_coords )
      deallocate( v1_dofmap )
    end if
    if ( allocated( v2_basis ) ) then
      deallocate( v2_basis )
      deallocate( v2_diff_basis )
      deallocate( v2_nodal_coords )
      deallocate( v2_dofmap )
    end if
    if ( allocated( v3_basis ) ) then
      deallocate( v3_basis )
      deallocate( v3_diff_basis )
      deallocate( v3_nodal_coords )
      deallocate( v3_dofmap )
    end if

    allocate(v0_basis(1,v_unique_dofs(1,2),ngp_h,ngp_v))
    allocate(v1_basis(3,v_unique_dofs(2,2),ngp_h,ngp_v))
    allocate(v2_basis(3,v_unique_dofs(3,2),ngp_h,ngp_v))
    allocate(v3_basis(1,v_unique_dofs(4,2),ngp_h,ngp_v))
    allocate(v0_diff_basis(3,v_unique_dofs(1,2),ngp_h,ngp_v))
    allocate(v1_diff_basis(3,v_unique_dofs(2,2),ngp_h,ngp_v))
    allocate(v2_diff_basis(1,v_unique_dofs(3,2),ngp_h,ngp_v))
    allocate(v3_diff_basis(1,v_unique_dofs(4,2),ngp_h,ngp_v))
    allocate(v0_nodal_coords(3,v_unique_dofs(1,2)))
    allocate(v1_nodal_coords(3,v_unique_dofs(2,2)))
    allocate(v2_nodal_coords(3,v_unique_dofs(3,2)))
    allocate(v3_nodal_coords(3,v_unique_dofs(4,2)))
    allocate( v0_dofmap(0:num_cells,v_unique_dofs(1,2)) )
    allocate( v1_dofmap(0:num_cells,v_unique_dofs(2,2)) )
    allocate( v2_dofmap(0:num_cells,v_unique_dofs(3,2)) )
    allocate( v3_dofmap(0:num_cells,v_unique_dofs(4,2)) )

    v0_basis=sqrt(2.0)
    v1_basis=sqrt(2.0)
    v2_basis=sqrt(2.0)
    v3_basis=sqrt(2.0)
    v0_diff_basis=atan(4.0)
    v1_diff_basis=atan(4.0)
    v2_diff_basis=atan(4.0)
    v3_diff_basis=atan(4.0)
    v0_nodal_coords(1,:)=0.152689632_r_def
    v0_nodal_coords(2,:)=0.562554751_r_def
    v0_nodal_coords(3,:)=-0.8234_r_def
    v1_nodal_coords(1,:)=0.152689632_r_def
    v1_nodal_coords(2,:)=0.562554751_r_def
    v1_nodal_coords(3,:)=-0.8234_r_def
    v2_nodal_coords(1,:)=0.152689632_r_def
    v2_nodal_coords(2,:)=0.562554751_r_def
    v2_nodal_coords(3,:)=-0.8234_r_def
    v3_nodal_coords(1,:)=0.152689632_r_def
    v3_nodal_coords(2,:)=0.562554751_r_def
    v3_nodal_coords(3,:)=-0.8234_r_def
    do i=0,num_cells
       v0_dofmap(i,:) = i+64
       v1_dofmap(i,:) = i+64
       v2_dofmap(i,:) = i+64
       v3_dofmap(i,:) = i+64
    end do

! Grab some of the contents of the module data for later testing
! before it is moved into the function space 
    test_v0_dofmap_result_1=v0_dofmap(0,1)
    test_v0_dofmap_result_2=v0_dofmap(num_cells-2,1)

    test_v0_basis_result=v0_basis(1,1,1,1)
    test_v0_diff_basis_result=v0_diff_basis(1,1,1,1)

    test_v0_nodal_coords_1=v0_nodal_coords(1,1)
    test_v0_nodal_coords_2=v0_nodal_coords(2,1)
    test_v0_nodal_coords_3=v0_nodal_coords(3,1)

    test_v1_dofmap_result_1=v1_dofmap(0,1)
    test_v1_dofmap_result_2=v1_dofmap(num_cells-2,1)

    test_v1_basis_result=v1_basis(1,1,1,1)
    test_v1_diff_basis_result=v1_diff_basis(1,1,1,1)

    test_v1_nodal_coords_1=v1_nodal_coords(1,1)
    test_v1_nodal_coords_2=v1_nodal_coords(2,1)
    test_v1_nodal_coords_3=v1_nodal_coords(3,1)

    test_v2_dofmap_result_1=v2_dofmap(0,1)
    test_v2_dofmap_result_2=v2_dofmap(num_cells-2,1)

    test_v2_basis_result=v2_basis(1,1,1,1)
    test_v2_diff_basis_result=v2_diff_basis(1,1,1,1)

    test_v2_nodal_coords_1=v2_nodal_coords(1,1)
    test_v2_nodal_coords_2=v2_nodal_coords(2,1)
    test_v2_nodal_coords_3=v2_nodal_coords(3,1)

    test_v3_dofmap_result_1=v3_dofmap(0,1)
    test_v3_dofmap_result_2=v3_dofmap(num_cells-2,1)

    test_v3_basis_result=v3_basis(1,1,1,1)
    test_v3_diff_basis_result=v3_diff_basis(1,1,1,1)

    test_v3_nodal_coords_1=v3_nodal_coords(1,1)
    test_v3_nodal_coords_2=v3_nodal_coords(2,1)
    test_v3_nodal_coords_3=v3_nodal_coords(3,1)

!v0
    v0_func_space = v0_func_space%get_instance(V0)

    ! test the procedures of the type
    testncell = v0_func_space%get_ncell()
    @assertEqual( num_cells, testncell )

    testundf = v0_func_space%get_undf()
    @assertEqual( num_unique_dofs, testundf )

    testmap => v0_func_space%get_cell_dofmap(0)
    @assertEqual( test_v0_dofmap_result_1, testmap(1) )

    testmap => v0_func_space%get_cell_dofmap(num_cells-2)    
    @assertEqual( test_v0_dofmap_result_2, testmap(1) )

    epsilon = 1.0e-14

    test_basis => v0_func_space%get_basis( )
    @assertEqual( test_v0_basis_result , test_basis(1,1,1,1), epsilon )

    test_basis => v0_func_space%get_diff_basis()
    @assertEqual( test_v0_diff_basis_result, test_basis(1,1,1,1), epsilon )

    test_nodes => v0_func_space%get_nodes( )
    @assertEqual( test_v0_nodal_coords_1, test_nodes(1,1), epsilon )
    @assertEqual( test_v0_nodal_coords_2, test_nodes(2,1), epsilon )
    @assertEqual( test_v0_nodal_coords_3, test_nodes(3,1), epsilon )

    test_fs = v0_func_space%which()
    @assertEqual(test_fs,V0)

!v1
    v1_func_space = v1_func_space%get_instance(V1)

    ! test the procedures of the type
    testncell = v1_func_space%get_ncell()
    @assertEqual( num_cells, testncell )

    testundf = v1_func_space%get_undf()
    @assertEqual( num_unique_dofs, testundf )

    testmap => v1_func_space%get_cell_dofmap(0)
    @assertEqual( test_v1_dofmap_result_1, testmap(1) )

    testmap => v1_func_space%get_cell_dofmap(num_cells-2)    
    @assertEqual( test_v1_dofmap_result_2, testmap(1) )

    epsilon = 1.0e-14

    test_basis => v1_func_space%get_basis( )
    @assertEqual( test_v1_basis_result, test_basis(1,1,1,1), epsilon )

    test_basis => v1_func_space%get_diff_basis()
    @assertEqual( test_v1_diff_basis_result, test_basis(1,1,1,1), epsilon )

    test_nodes => v1_func_space%get_nodes( )
    @assertEqual( test_v1_nodal_coords_1, test_nodes(1,1), epsilon )
    @assertEqual( test_v1_nodal_coords_2, test_nodes(2,1), epsilon )
    @assertEqual( test_v1_nodal_coords_3, test_nodes(3,1), epsilon )

    test_fs = v1_func_space%which()
    @assertEqual(test_fs,V1)

!v2
    v2_func_space = v2_func_space%get_instance(V2)

    ! test the procedures of the type
    testncell = v2_func_space%get_ncell()
    @assertEqual( num_cells, testncell )

    testundf = v2_func_space%get_undf()
    @assertEqual( num_unique_dofs, testundf )

    testmap => v2_func_space%get_cell_dofmap(0)
    @assertEqual( test_v2_dofmap_result_1, testmap(1) )

    testmap => v2_func_space%get_cell_dofmap(num_cells-2)    
    @assertEqual( test_v2_dofmap_result_2, testmap(1) )

    epsilon = 1.0e-14

    test_basis => v2_func_space%get_basis( )
    @assertEqual( test_v2_basis_result, test_basis(1,1,1,1), epsilon )

    test_basis => v2_func_space%get_diff_basis()
    @assertEqual( test_v2_diff_basis_result, test_basis(1,1,1,1), epsilon )

    test_nodes => v2_func_space%get_nodes( )
    @assertEqual( test_v2_nodal_coords_1, test_nodes(1,1), epsilon )
    @assertEqual( test_v2_nodal_coords_2, test_nodes(2,1), epsilon )
    @assertEqual( test_v2_nodal_coords_3, test_nodes(3,1), epsilon )

    test_fs = v2_func_space%which()
    @assertEqual(test_fs,V2)

!v3
    v3_func_space = v3_func_space%get_instance(V3)

    ! test the procedures of the type
    testncell = v3_func_space%get_ncell()
    @assertEqual( num_cells, testncell )

    testundf = v3_func_space%get_undf()
    @assertEqual( num_unique_dofs, testundf )

    testmap => v3_func_space%get_cell_dofmap(0)
    @assertEqual( test_v3_dofmap_result_1, testmap(1) )

    testmap => v3_func_space%get_cell_dofmap(num_cells-2)    
    @assertEqual( test_v3_dofmap_result_2, testmap(1) )

    epsilon = 1.0e-14

    test_basis => v3_func_space%get_basis( )
    @assertEqual( test_v3_basis_result, test_basis(1,1,1,1), epsilon )

    test_basis => v3_func_space%get_diff_basis()
    @assertEqual( test_v3_diff_basis_result, test_basis(1,1,1,1), epsilon )

    test_nodes => v3_func_space%get_nodes( )
    @assertEqual( test_v3_nodal_coords_1, test_nodes(1,1), epsilon )
    @assertEqual( test_v3_nodal_coords_2, test_nodes(2,1), epsilon )
    @assertEqual( test_v3_nodal_coords_3, test_nodes(3,1), epsilon )

    test_fs = v3_func_space%which()
    @assertEqual(test_fs,V3)


  end subroutine test_func_space

end module function_space_mod_test
