catalyst_demo miniapp
=====================

This miniapp is based on the gravity wave miniapp and demonstrates in-situ visualisation with ParaView Catalyst.

Building the miniapp
====================

The catalyst_demo miniapp requires the following external dependencies:

1. ParaView Catalyst

Catalyst is part of ParaView and thus may already be available on your system in a ParaView module. It can also
be built as a standalone package using Catalyst Editions (see https://www.paraview.org/download). This option has
the advantage that the Catalyst libray can be reduced to minimal size, only containing the visualisation features
needed by a given project. Make sure that you choose an edition that includes Python pipelines and rendering.

For code development, it is highly recommended to use a complete ParaView build and thus enable the full featureset
for maximum flexibility. You will also need to enable "vtkGeovisCore" in your ParaView/Catalyst build if you want
to use cartographic projections with the PROJ4 library.

2. Catalyst Adaptor library

The Catalyst Adaptor library can be downloaded from GitHub:
https://github.com/tinyendian/catalyst_adaptor

Follow the instructions on the GitHub page to build the libray using the CMake build system. Further Python pipeline
examples for in-situ visualisation can also be found in this repository.

With these dependencies in place, it should now be possible to build the "catalyst_demo" miniapp, pointing the
build system to the locations of the Catalyst and Catalyst Adaptor libraries.

Catalyst is currently linked dynamically to simplify the linking process, static linking will be enabled later on.

Running the miniapp
===================

Make sure that the following environment variables are set before you launch the miniapp:

LD_LIBRARY_PATH=/path/to/ParaView/lib/paraview-5.4:$LD_LIBRARY_PATH
PYTHONPATH=/path/to/ParaView/lib/paraview-5.4/site-packages:/path/to/ParaView/lib/paraview-5.4/site-packages/vtk:$PYTHONPATH

The Python distribution also needs to include the NumPy package if you want to export visualisations to a
Cinema database.

You should now be able to run the miniapp, and it should produce a series of visualisation output files:

spherical_slice_*vtp  -- VTK XML format output containing all simulation fields on a spherical slice,
                         for analysis with ParaView, VisIt, or the VTK Python package. One file is
                         generated per MPI rank and timestep. The additional ".pvtp" files contain
                         metadata for each timestep.
spherical_slice_*.png -- rendered images of the pressure field on the slice in PNG format.

Enabling ParaView Live
======================

ParaView Live allows users to connect to the running simulation with the ParaView GUI and visualise
simulation output as it is created.

You will first need to download or build the ParaView GUI (see https://www.paraview.org/download).

IMPORTANT: Make sure that the ParaView GUI and Catalyst library are from the exact same ParaView version!
           It is no problem to mix operating systems (e.g., Catalyst library on Linux with a Windows GUI).

Edit the Python pipeline file "miniapps/catalyst_demo/example/pipelines/spherical_slice_rendered.py" and
replace

coprocessor.EnableLiveVisualization(False)

with

coprocessor.EnableLiveVisualization(True)

near the end of the file.

If you run the simulation with Catalyst on a remote system, you will need to create a remote ssh tunnel
that forwards port "22222" (this is the default, the port number can be set in "spherical_slice_rendered.py")
to your local machine. You may also need to enable incoming connections from this port in the firewall of
your local machine.

To start the session,

1. Launch the ParaView GUI, navigate to "Catalyst > Connect..." in the menu bar and confirm the port
   number in the dialog box - ParaView GUI will now listen to incoming connections from Catalyst
2. Launch the "catalyst_demo" miniapp - the visualisation pipeline should appear in the "Pipeline Browser"
   panel on the left of the ParaView GUI window after a few seconds, when the miniapp initialises Catalyst
3. Navigate to "Catalyst > Pause Simulation"
4. Click on the small download icon (circle with a triangle) on the left of "Slice1" - this will download
   the sliced data to the GUI for further analysis (same for "input" if you want the full 3D dataset),
   it will appear as "Extract: Slice1" in the pipeline browser
5. Navigate to "Catalyst > Continue" to release the simulation

Note that Catalyst will keep downloading updated data as the simulation proceeds as long as you leave
the downloaded dataset(s) (prefixed with "Extract:" in place, which may degrade simulation performance.
Simply delete the downloaded datasets in the "Properties" tab below the pipeline browser to avoid
this behaviour.

Troubleshooting:
* Make sure that "EnableLiveVisualization" is set to "True" before you launch the simulation
* Check if the ssh tunnel is still active if you run on a remote system
* Make sure that ParaView Catalyst and ParaView GUI come from the same version of ParaView
* Check if you firewall allows connections on port "22222" (or whichever port was set)
* Reboot your local machine, e.g., after a system software update
