#!/bin/sh
###############################################################################
# (c) Crown copyright 2024 Met Office. All rights reserved.
# The file LICENCE, distributed with this code, contains details of the terms
# under which the code may be used.
###############################################################################
# tweak_iodef:
#    replace relative path to LFRic dictionary with env symbol and
#    resolve env symbols 
# in iodef.xml before rose suite starts.

iodef=iodef.xml
case $# in 
0) ;;
1) iodef=$1 ;;
*) echo 'usage: tweak_iodef [iodef_file]' 1>&2; exit 2
esac

set -e
temp_file=$(mktemp)
trap 'rm -f $temp_file; exit 1' INT TERM EXIT
# examples substitutions
#   ../../../lfric_atm/metadata              used in gungho_model/example 
#   ../metadata -> $METADATA                 used in lfric_atm/example
if  sed 's@\.\./\(\.\./\)*lfric_atm/metadata@$METADATA@' $iodef |\
    sed 's@\.\./\(\.\./\)*metadata@$METADATA@' |\
    rose env-cat - >$temp_file
then
    trap '' INT TERM EXIT
    cp $temp_file $iodef
else
    echo "tweak_iodef: editing failed, $iodef unchanged" 1>&2
    rm -f $temp_file
    exit 1
fi
rm -f $temp_file
