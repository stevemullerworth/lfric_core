!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

!> Test the global_mesh module
!>
module global_mesh_mod_test

  use pFUnit_Mod
  use constants_mod, only : r_def, i_def

  implicit none 

  private
  public test_global_mesh, setUp, tearDown

  @testCase
  type, public, extends( TestCase ) :: global_mesh_test_type
  contains
    procedure :: setUp
    procedure :: tearDown
    procedure :: test_global_mesh
  end type global_mesh_test_type

contains

  subroutine setup( this )

    use reference_element_mod, only : reference_cube

    implicit none

    class( global_mesh_test_type ), intent( inout ) :: this

    ! Set up stuff that the global_mesh object needs
    call reference_cube()

  end subroutine setup

  subroutine teardown( this )

    use reference_element_mod, only : deallocate_reference

    implicit none

    class( global_mesh_test_type ), intent( inout ) :: this

    ! clean up the reference_cube we created at the start of the test
    call deallocate_reference()

  end subroutine teardown

  !> Test global_mesh module functionality
  !>
  @test
  subroutine test_global_mesh( this )
  use constants_mod,         only : str_max_filename
  use reference_element_mod, only : reference_cube, deallocate_reference
  use global_mesh_mod,       only : global_mesh_type
  use global_mesh_map_collection_mod, only : global_mesh_map_collection_type

  implicit none

  class( global_mesh_test_type ), intent( inout ) :: this
 
  type(global_mesh_type) :: global_mesh
  type(global_mesh_map_collection_type), pointer ::                            &
                                         global_mesh_map_collection => null()

  integer(i_def) :: cell_id
  integer(i_def) :: verts(4)
  integer(i_def) :: edges(4)
  integer(i_def) :: cells(4)
  integer(i_def) :: ncells
  integer(i_def) :: ncells_x
  integer(i_def) :: ncells_y
  integer(i_def) :: max_cells_on_vert
  integer(i_def) :: cell_owner

  real(r_def) :: dx
  real(r_def) :: dy

  character(len = str_max_filename) :: filename

  !-------------------------------------
  ! Test construction of a biperiodic mesh
  !-------------------------------------

  filename = 'data/ugrid_quads_2d_biperiodic_8x8.nc' 
  global_mesh = global_mesh_type( filename )
  !
  ! Generate the global_mesh
  cell_id = global_mesh%get_cell_id( 1, 0, 0 )
  @assertEqual( 1, cell_id )
  !
  ! Test functionality of the global_mesh object we've just created
  cell_id = global_mesh%get_cell_id( 1, 2, 2 )
  @assertEqual( 51, cell_id )

  call global_mesh%get_vert_on_cell( 6, verts )
  @assertEqual( 12, verts(1) )
  @assertEqual( 14, verts(2) )
  @assertEqual( 13, verts(3) )
  @assertEqual( 11, verts(4) )

  call global_mesh%get_cell_on_vert( 15, cells )
  @assertEqual(  7, cells(1) )
  @assertEqual(  8, cells(2) )
  @assertEqual( 63, cells(3) )
  @assertEqual( 64, cells(4) )

  call global_mesh%get_edge_on_cell( 6, edges )
  @assertEqual( 14, edges(1) )
  @assertEqual( 18, edges(2) )
  @assertEqual( 17, edges(3) )
  @assertEqual( 16, edges(4) )

  call global_mesh%get_cell_on_edge( 17, cells(1:2) )
  @assertEqual(  6, cells(1) )
  @assertEqual(  7, cells(2) )

  ncells = global_mesh%get_ncells()
  @assertEqual( 64, ncells )

  max_cells_on_vert=global_mesh%get_max_cells_per_vertex()
  @assertEqual( 4, max_cells_on_vert )

  !---------------------------------------
  ! Test construction of a cubed-sphere mesh
  !---------------------------------------
  filename = 'data/ugrid_quads_2d_cubedsphere_6x4x4.nc' 
  global_mesh = global_mesh_type( filename )
  !
  ! Generate the global_mesh
  cell_id = global_mesh%get_cell_id( 1, 0, 0 )
  @assertEqual( 1, cell_id )
  !
  ! Test functionality of the global_mesh object we've just created
  cell_id = global_mesh%get_cell_id( 1, 2, 2 )
  @assertEqual( 74, cell_id )

  call global_mesh%get_vert_on_cell( 6, verts )
  @assertEqual( 10, verts(1) )
  @assertEqual( 11, verts(2) )
  @assertEqual(  7, verts(3) )
  @assertEqual(  6, verts(4) )

  call global_mesh%get_cell_on_vert( 16, cells )
  @assertEqual( 11, cells(1) )
  @assertEqual( 12, cells(2) )
  @assertEqual( 15, cells(3) )
  @assertEqual( 16, cells(4) )

  call global_mesh%get_edge_on_cell( 6, edges )
  @assertEqual( 15, edges(1) )
  @assertEqual( 16, edges(2) )
  @assertEqual( 17, edges(3) )
  @assertEqual(  6, edges(4) )

  call global_mesh%get_cell_on_edge( 13, cells(1:2) )
  @assertEqual(  5, cells(1) )
  @assertEqual( 56, cells(2) )

  ncells = global_mesh%get_ncells()
  @assertEqual( 96, ncells )

  max_cells_on_vert=global_mesh%get_max_cells_per_vertex()
  @assertEqual( 4, max_cells_on_vert )

  cell_owner=global_mesh%get_vert_cell_owner(1)
  @assertEqual( 65, cell_owner )

  cell_owner=global_mesh%get_edge_cell_owner(1)
  @assertEqual( 65, cell_owner )


  ! Test retrival of mesh map collection from this global mesh object
  global_mesh_map_collection => global_mesh%get_global_mesh_maps()
  @assertEqual( global_mesh_map_collection%get_source_id(),     global_mesh%get_id())
  @assertEqual( global_mesh_map_collection%get_source_ncells(), global_mesh%get_ncells())


  end subroutine test_global_mesh

end module global_mesh_mod_test
