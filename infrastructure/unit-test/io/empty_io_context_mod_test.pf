!-----------------------------------------------------------------------------
! (c) Crown copyright 2018 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> @brief Test the selected functionality of io_mod
!>
!> @details A pFUnit test module to exercise the functionality in io_mod.
!>
module empty_io_context_mod_test

  use mpi_mod, only : global_mpi
  use pfunit

  implicit none

  private
  public :: set_up, tear_down, test_empty_io_context
  !
  ! pFUnit requirest symbol spillage
  !
  public :: MPITestMethod, MPITestParameter

contains

  @before
  subroutine set_up(this)

    implicit none

    class(MPITestMethod), intent(inout) :: this

    call global_mpi%initialise(this%getMpiCommunicator())

  end subroutine set_up


  @after
  subroutine tear_down(this)

    implicit none

    class(MPITestMethod), intent(inout) :: this

    call global_mpi%finalise()

  end subroutine tear_down

  ! Test filename generation for restart files
  @test( npes=[1] )
  subroutine test_empty_io_context(this)
    use empty_io_context_mod, only: empty_io_context_type
    use linked_list_mod, only: linked_list_type
    use linked_list_int_mod, only: linked_list_int_type

    implicit none

    class(MPITestMethod), intent(inout) :: this

    type(empty_io_context_type) :: test_io_context
    type(linked_list_type), target :: tmp_list
    type(linked_list_type), pointer :: filelist => null()

    tmp_list = linked_list_type()
    call tmp_list%insert_item(linked_list_int_type(1))
    filelist => tmp_list
    @assertTrue(associated(filelist, tmp_list))
    call test_io_context%initialise("empty_context")

    filelist => test_io_context%get_filelist()
    @assertFalse(associated(filelist))

  end subroutine test_empty_io_context

end module empty_io_context_mod_test
