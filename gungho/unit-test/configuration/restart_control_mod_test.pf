!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------
!
module restart_control_mod_test

  use pFUnit_mod

  implicit none

  private
  public :: test_basic

  @TestCase
  type, public, extends(TestCase) :: restart_control_test_type

    private

  contains

    procedure setUp
    procedure tearDown
    procedure test_basic

  end type restart_control_test_type

contains

  ! The code under test will log events. These end up on standard-out. This
  ! causes problems with pFunit. To prevent this we redirect the logged output
  ! to a scratch file.
  !
  subroutine setUp( this )

    use log_mod, only : log_set_info_stream

    implicit none

    class(restart_control_test_type), intent(inout) :: this

    integer :: condition

    open( 8, status='scratch', action='readwrite', iostat=condition )
    @assertEqual(0, condition )
    call log_set_info_stream( 8 )

  end subroutine setUp

  ! Restore logging to standard-out once the test is complete.
  !
  subroutine tearDown( this )

    use iso_fortran_env, only : output_unit
    use log_mod,         only : log_set_info_stream

    implicit none

    class(restart_control_test_type), intent(inout) :: this

    integer :: condition

    call log_set_info_stream( output_unit )

    close( 8, iostat=condition )
    @assertEqual( 0, condition )

  end subroutine tearDown

  @test
  subroutine test_basic( this )

    use constants_mod,       only : str_max_filename
    use restart_control_mod, only : restart_type

    implicit none

    class(restart_control_test_type), intent(inout) :: this

    character(len=str_max_filename) :: rs_fname
    character(len=str_max_filename) :: fname,tname
    type(restart_type) :: restart
    integer :: ts_start, ts_end, df
    logical :: ck_r, ck_w

    write(rs_fname,'(A)') "data/rs_test.nml"
    restart = restart_type(rs_fname, 0, 1)

    ! now for some tests 
    ts_start=4
    ts_end=6
    df=3
    ck_r=.true.
    ck_w=.true.

    @assertEqual(restart%ts_start(),ts_start)
    @assertEqual(restart%ts_end(),ts_end)
    @assertEqual(restart%get_checkpoint_frequency(),df)
    @assertTrue(restart%read_file().eqv.ck_r)
    @assertTrue(restart%write_file().eqv.ck_w)

    write(tname,'(A,A,A,A,I6.6)') "hswarez_100day","_", &
         "rho","_T",ts_start-1
    fname=restart%startfname("rho")
    @assertEqual(tname,fname)

    write(tname,'(A,A,A,A,I6.6)') "hswarez_100day","_", &
         "rho","_T",ts_end
    fname=restart%endfname("rho")
    @assertEqual(tname,fname)

    write(tname,'(A,A,A,A,I6.6)') "hswarez_100day","_", &
         "rho","_T",7
    fname=restart%ts_fname("rho",7)
    @assertEqual(tname,fname)

  end subroutine test_basic

end module restart_control_mod_test
