!-----------------------------------------------------------------------------
! (c) Crown copyright 2020 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test the application of the helmholtz operator
!>
module apply_helmholtz_operator_kernel_mod_test

  use constants_mod, only : i_def, r_def
  use pFUnit_Mod
  implicit none

  private
!  public :: test_all

  @TestCase
  type, extends(TestCase), public :: apply_helmholtz_operator_test_type
    private
  contains
    procedure setUp
    procedure tearDown
!    procedure test_all
  end type apply_helmholtz_operator_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    implicit none

    class(apply_helmholtz_operator_test_type), intent(inout) :: this

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(apply_helmholtz_operator_test_type), intent(inout) :: this

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! ToDo: This test was broken when it went on trunk but it slipped by review
!       because a fault in the test suite meant unit tests were not being run.
!
!  @Test( )
!  subroutine test_all( this )
!
!    use apply_helmholtz_operator_kernel_mod, only : apply_helmholtz_operator_code
!
!    implicit none
!
!    class(apply_helmholtz_operator_test_type), intent(inout) :: this
!
!    real(r_def), parameter :: tol = 1.0e-12_r_def
!
!    ! Mesh
!    integer(i_def), parameter :: nlayers = 5
!    integer(i_def), parameter :: stencil_size = 5
!
!    ! Spaces
!    integer(i_def), parameter :: ndf_w3 = 1
!    integer(i_def), parameter :: undf_w3 = ndf_w3*nlayers*stencil_size
!
!    ! Maps
!    integer(i_def), dimension(ndf_w3)              :: map_w3
!    integer(i_def), dimension(ndf_w3,stencil_size) :: smap_w3
!
!    ! Fields
!    real(r_def), dimension(undf_w3) :: Hp, p
!    real(r_def), dimension(undf_w3) :: HC, HN, HE, HS, HW, HU, HD, HUU, HDD
!
!    integer(i_def) :: df, k
!    real(r_def)    :: answer
!
!    map_w3 = (/ 1_i_def /)
!    do df = 1,stencil_size
!      smap_w3(1,df) = 1 + (df-1)*nlayers
!    end do
!
!    ! Set up the fields
!    do df = 1,undf_w3
!      p(df) = real(df,r_def)
!    end do
!    HC(:)  = 2.0_r_def
!    HN(:)  = 3.0_r_def
!    HE(:)  = 4.0_r_def
!    HS(:)  = 5.0_r_def
!    HW(:)  = 6.0_r_def
!    HU(:)  = 7.0_r_def
!    HD(:)  = 8.0_r_def
!    HUU(:) = 9.0_r_def
!    HDD(:) = 10.0_r_def
!    Hp = 0.0_r_def
!
!    ! Compute Hp = H*p
!    call apply_helmholtz_operator_code(nlayers,                 &
!                                       Hp,                      &
!                                       p,                       &
!                                       stencil_size, smap_w3,   &
!                                       HC, HN, HE, HS, HW,      &
!                                       HU, HUU, HD, HDD,        &
!                                       ndf_w3, undf_w3, map_w3)
!
!    ! layer 3:
!    k = 2
!    answer = HC(2)*p(map_w3(1)+k) &
!           + HW(2)*p(smap_w3(1,2)+k) + HS(2)*p(smap_w3(1,3)+k) + HE(2)*p(smap_w3(1,4)+k) + HN(2)*p(smap_w3(1,5)+k) &
!           + HU(2)*p(map_w3(1)+k+1) + HUU(2)*p(map_w3(1)+k+2) + HD(2)*p(map_w3(1)+k-1) + HDD(2)*p(map_w3(1)+k-2)
!    @assertEqual(answer, Hp(map_w3(1)+k), tol)
!
!  end subroutine test_all

end module apply_helmholtz_operator_kernel_mod_test
