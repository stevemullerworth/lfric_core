!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------

!> Test the W1 mass matrix computation
!>
module compute_mass_matrix_kernel_w1_mod_test

    use constants_mod, only : i_def, r_def
    use get_unit_test_m3x3_dofmap_mod, &
      only : get_w0_m3x3_dofmap
    use get_unit_test_m3x3_q3x3x3_sizes_mod, &
      only : get_w0_m3x3_q3x3x3_size, get_w1_m3x3_q3x3x3_size
    use get_unit_test_q3x3x3_basis_mod, &
      only : get_w0_q3x3x3_diff_basis, get_w1_q3x3x3_basis
    use get_unit_test_q3x3x3_quadrature_mod,            &
      only : get_gaussian_q3x3x3_quadrature_weights_xy, &
             get_gaussian_q3x3x3_quadrature_weights_z
    use get_unit_test_3x3x3_chi_mod, &
      only : get_w0_3x3x3_field
    use mpi_mod,       only : store_comm, clear_comm
    use pFUnit_Mod
    use yaxt,          only : xt_initialize, xt_finalize

  implicit none

  private
  public :: test_all

  @TestCase
  type, extends(MPITestCase), public :: compute_mass_matrix_w1_test_type
    private
  contains
    procedure setUp
    procedure tearDown
    procedure test_all
  end type compute_mass_matrix_w1_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    use finite_element_config_mod, &
      only : cellshape_quadrilateral
    use mesh_mod,                  only : PLANE_BI_PERIODIC

    implicit none

    class(compute_mass_matrix_w1_test_type), intent(inout) :: this

    ! Initialise YAXT
    call xt_initialize(this%getMpiCommunicator())
    !Store the MPI communicator for later use
    call store_comm(this%getMpiCommunicator())

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(compute_mass_matrix_w1_test_type), intent(inout) :: this

    ! Finalise YAXT
    call xt_finalize()
    ! Clear the stored MPI communicator
    call clear_comm()

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test( npes=[1] )
  subroutine test_all( this )

    use compute_mass_matrix_kernel_w1_mod, only : compute_mass_matrix_w1_code

    implicit none

    class(compute_mass_matrix_w1_test_type), intent(inout) :: this

    real(r_def), parameter :: tol = 1.0e-6_r_def
    real(r_def), parameter :: dx = 6000.0_r_def
    real(r_def), parameter :: dy = 1000.0_r_def
    real(r_def), parameter :: dz = 2000.0_r_def
    integer(i_def), parameter :: nlayers = 3

    integer :: i, j, k, cell

    ! Required for calling mass matrix kernel
    integer(i_def) :: ndf_w0, undf_w0
    integer(i_def) :: ndf_w1
    integer(i_def) :: ncells, ncell_3d
    integer(i_def) :: nqp_h, nqp_v
    integer(i_def) :: unused

    integer(i_def), allocatable :: map_w0(:,:)

    real(r_def), allocatable :: chi1(:), chi2(:), chi3(:)
    real(r_def), allocatable :: diff_basis_w0(:,:,:,:)
    real(r_def), allocatable :: basis_w1(:,:,:,:)
    real(r_def), allocatable :: wh(:), wv(:)
    real(r_def), allocatable :: local_stencil(:,:,:)

    real(r_def), dimension(12,12) :: answer

    call get_w0_m3x3_q3x3x3_size( ndf_w0, undf_w0, ncells, &
                                  unused, unused,          &
                                  nqp_h, nqp_v, nlayers=nlayers)
    call get_w0_m3x3_dofmap( map_w0 )
    call get_w0_q3x3x3_diff_basis( diff_basis_w0 )
    call get_w1_m3x3_q3x3x3_size( ndf_w1, unused, unused, &
                                  unused, unused,         &
                                  unused, unused, nlayers=nlayers)
    call get_w1_q3x3x3_basis( basis_w1 )
    call get_gaussian_q3x3x3_quadrature_weights_xy( wh )
    call get_gaussian_q3x3x3_quadrature_weights_z( wv )

    ! Compute coordinates
    allocate(chi1(undf_w0))
    allocate(chi2(undf_w0))
    allocate(chi3(undf_w0))

    call get_w0_3x3x3_field(chi1, chi2, chi3, dx, dy, dz, &
                            map_w0, nlayers)

    ! Test mass matrix kernel
    cell = 1
    ncell_3d = ncells * nlayers
    allocate( local_stencil(ndf_w1, ndf_w1, ncell_3d) )
    local_stencil(:,:,:) = 0.0_r_def
    call compute_mass_matrix_w1_code( cell,            &
                                      nlayers,         &
                                      ncell_3d,        &
                                      local_stencil,   &
                                      chi1,            &
                                      chi2,            &
                                      chi3,            &
                                      ndf_w1,          &
                                      basis_w1,        &
                                      ndf_w0,          &
                                      undf_w0,         &
                                      map_w0(:, cell), &
                                      diff_basis_w0,   &
                                      nqp_h,           &
                                      nqp_v,           &
                                      wh,              &
                                      wv               &
                                      )

    call mass_matrix_w1(answer)
    ! Normalise by average edge length
    answer(:,:) = answer(:,:) * 3.0_r_def / (dx + dy + dz )
    local_stencil(:, :, 1 ) =  local_stencil(:, :, 1 ) &
                               * 3.0_r_def / (dx + dy + dz )
    @assertEqual(answer, local_stencil(:, :, 1 ), tol)

    deallocate( local_stencil )
    deallocate( chi3, chi2, chi1 )
    deallocate( wv, wh )
    deallocate( basis_w1 )
    deallocate( diff_basis_w0, map_w0 )

  end subroutine test_all

  subroutine mass_matrix_w1( mm )
    use constants_mod, only: r_def
    implicit none

    real(kind=r_def), dimension(12,12), intent(inout) :: mm
    mm = reshape( [ &
  0.1333333333333320E+04_r_def, &
  0.0000000000000000E+00_r_def, &
  0.6666666666666615E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.6666666666666614E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.3333333333333312E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.3703703703703668E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1851851851851837E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1851851851851837E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.9259259259259201E+01_r_def, &
  0.6666666666666615E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1333333333333321E+04_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.3333333333333312E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.6666666666666615E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1851851851851837E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.3703703703703667E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.9259259259259201E+01_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1851851851851837E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.3333333333333302E+03_r_def, &
  0.1666666666666653E+03_r_def, &
  0.8333333333333280E+02_r_def, &
  0.1666666666666653E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1666666666666653E+03_r_def, &
  0.3333333333333301E+03_r_def, &
  0.1666666666666653E+03_r_def, &
  0.8333333333333280E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.8333333333333280E+02_r_def, &
  0.1666666666666653E+03_r_def, &
  0.3333333333333302E+03_r_def, &
  0.1666666666666653E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1666666666666653E+03_r_def, &
  0.8333333333333280E+02_r_def, &
  0.1666666666666653E+03_r_def, &
  0.3333333333333301E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.6666666666666614E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.3333333333333312E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1333333333333321E+04_r_def, &
  0.0000000000000000E+00_r_def, &
  0.6666666666666614E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1851851851851837E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.9259259259259201E+01_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.3703703703703668E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1851851851851837E+02_r_def, &
  0.3333333333333312E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.6666666666666615E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.6666666666666614E+03_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1333333333333321E+04_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.9259259259259201E+01_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1851851851851837E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.0000000000000000E+00_r_def, &
  0.1851851851851837E+02_r_def, &
  0.0000000000000000E+00_r_def, &
  0.3703703703703668E+02_r_def  &
    ], shape(mm) )
    return
  end subroutine mass_matrix_w1

end module compute_mass_matrix_kernel_w1_mod_test
